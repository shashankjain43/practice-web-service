<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="com.snapdeal.payments.view.mapper.IMerchantViewMapper">
	<resultMap id="mvTxnDTO"
		type="com.snapdeal.payments.merchantView.commons.dto.MVTransactionDTO">
		<result column="txn_date" property="txnDate" />
		<result column="freecharge_txn_id" property="fcTxnId" />
		<result column="merchant_txn_id" property="merchantTxnId" />
		<result column="merchant_txn_id" property="orderId" />
		<result column="merchant_txn_type" property="txnType"
			javaType="com.snapdeal.payments.merchantView.commons.enums.MVTransactionType"
			typeHandler="com.snapdeal.payments.view.typeHandler.MVTransactionTypeHandler" />
		<result column="txn_state" property="txnStatus"
			javaType="com.snapdeal.payments.merchantView.commons.enums.MVTransactionStatus"
			typeHandler="com.snapdeal.payments.view.typeHandler.MVTransactionStatusHandler" />
		<result column="merchant_fee" property="merchantFee" />
		<result column="service_tax" property="serviceTax" />
		<result column="swach_bharat_cess" property="swachBharatCess" />
		<result column="txn_amount" property="totalTxnAmount" />
		<result column="net_deduction" property="netDeduction" />
		<result column="amount_payable" property="payableAmount" />
		<result column="merchant_Id" property="merchantId" />
		<result column="store_name" property="storeName" />
		<result column="store_id" property="storeId" />
		<result column="terminal_id" property="terminalId" />
		<!-- <result column="customer_id" property="custId" /> -->
		<result column="customer_name" property="custName" />
		<result column="product_id" property="productId" />
		<result column="merchant_name" property="merchantName" />
		<result column="custmer_ip" property="custIP" />
		<result column="location" property="location" />
		<result column="shipping_city" property="shippingCity" />
		<result column="settlement_id" property="settlementId" />

	</resultMap>

	<sql id="base_column_list_txn_detail">
		txn_date,
		freecharge_txn_id,
		merchant_txn_id,
		settlement_id,
		merchant_txn_type,
		merchant_txn_id,
		merchant_fee,
		txn_amount,
		service_tax,
		swach_bharat_cess,
		amount_payable,
		net_deduction,
		merchant_Id,
		merchant_name,
		<!-- customer_id, -->
		customer_name,
		store_id,
		store_name,
		product_id,
		terminal_id,
		custmer_ip,
		location,
		shipping_city
	</sql>
	<sql id="base_column_list_txn_state">
		txn_state,txn_state_details.tsm_time_stamp,txn_state_details.txn_id
	</sql>


	<sql id="dynamic_sql">

		<if test="filters!=null">
			<if test="filters.txnTypeList!=null and !filters.txnTypeList.isEmpty()">
				AND txn_details.merchant_txn_type IN
				<foreach item="item" index="index" collection="filters.txnTypeList"
					open="(" separator="," close=")">
					#{item}
				</foreach>
			</if>

			<if
				test="filters.txnStatusList!=null and !filters.txnStatusList.isEmpty()">
				AND txn_state_details.txn_state IN
				<foreach item="item" index="index" collection="filters.txnStatusList"
					open="(" separator="," close=")">
					#{item}
				</foreach>
			</if>
			
			
			<if test="filters.fromAmount!=null and filters.toAmount!=null">
				AND txn_details.txn_amount <![CDATA[>=]]> #{filters.fromAmount}
				AND txn_details.txn_amount <![CDATA[<=]]> #{filters.toAmount}
			</if>
			<if test="filters.fromAmount!=null and filters.toAmount==null">
				AND txn_details.txn_amount <![CDATA[>=]]> #{filters.fromAmount}
			</if>
			<if test="filters.fromAmount==null and filters.toAmount!=null">
				AND txn_details.txn_amount <![CDATA[<=]]> #{filters.toAmount}
			</if>

			<if test="filters.startDate!=null and filters.endDate!=null">
				AND txn_details.txn_date <![CDATA[>=]]> #{filters.startDate} 
				AND txn_details.txn_date <![CDATA[<=]]> #{filters.endDate}
				
			</if>
			<if test="filters.startDate!=null and filters.endDate==null">
				AND txn_details.txn_date <![CDATA[>=]]> #{filters.startDate}
			</if>
			<if test="filters.startDate==null and filters.endDate!=null">
				AND txn_details.txn_date <![CDATA[<=]]> #{filters.endDate}
			</if>
		</if>
	</sql>

	<select id="getTxnsForFilters" resultMap="mvTxnDTO"
		parameterType="com.snapdeal.payments.merchantView.service.impl.GetMerchantViewFilterMapperRequest">
		SELECT
		<include refid="base_column_list_txn_detail" />
		,
		<include refid="base_column_list_txn_state" />
		FROM
		txn_details, txn_state_details
		WHERE
		txn_details.txn_id = txn_state_details.txn_id AND
		txn_details.merchant_Id = #{merchantId}

		AND txn_state_details.tsm_time_stamp =
		(
		select max(tsd.tsm_time_stamp) as latest_date from txn_state_details tsd
		where txn_state_details.txn_id=tsd.txn_id)

		<include refid="dynamic_sql"></include>

		ORDER BY txn_details.txn_date

		<if test="orderby ==1">
			DESC
		</if>

		LIMIT #{offset}, #{limit}
	</select>


	<select id="getTxnsForSearchCriteria" resultMap="mvTxnDTO"
		parameterType="com.snapdeal.payments.merchantView.service.impl.GetMerchantViewSearchMapperRequest">
		SELECT
		<include refid="base_column_list_txn_detail" />
		,
		<include refid="base_column_list_txn_state" />
		FROM
		txn_details, txn_state_details
		WHERE
		txn_details.txn_id = txn_state_details.txn_id AND
		txn_details.merchant_Id = #{merchantId} AND

		<if test="searchCriteria!=null">
			(
			<if test="searchCriteria.transactionId!=null">
				txn_details.freecharge_txn_id =
				#{searchCriteria.transactionId} OR
			</if>
			<if test="searchCriteria.merchantTxnId!=null">
				txn_details.merchant_txn_id = #{searchCriteria.merchantTxnId} OR
			</if>
			<if test="searchCriteria.settlementId!=null">
				txn_details.settlement_id = #{searchCriteria.settlementId} OR
			</if>
			<if test="searchCriteria.customerId!=null">
				txn_details.customer_id = #{searchCriteria.customerId} OR
			</if>
			<if test="searchCriteria.orderId!=null">
				txn_details.merchant_txn_id = #{searchCriteria.orderId} OR
			</if>
			<if test="searchCriteria.productId!=null">
				txn_details.product_id = #{searchCriteria.productId} OR
			</if>
			<if test="searchCriteria.terminalId!=null">
				txn_details.terminal_id = #{searchCriteria.terminalId} OR
			</if>
			<if test="searchCriteria.storeId!=null">
				txn_details.store_id = #{searchCriteria.storeId} OR
			</if>
			<![CDATA[
			1>2)]]>
		</if>

		ORDER BY txn_details.txn_date

		<if test="orderby==1">
			DESC
		</if>
		LIMIT #{offset}, #{limit}
	</select>

</mapper>