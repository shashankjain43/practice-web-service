<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- customerId need to be add -->
<mapper
	namespace="com.snapdeal.payments.view.mapper.MerchantViewAuditMapper">

	<resultMap id="resultMerchantViewAudit"
		type="com.snapdeal.payments.view.entity.MerchantViewAuditEntity">
		<result column="freecharge_txn_id" property="fcTxnId" />
		<result column="txn_type" property="txnType" />
		<result column="merchant_id" property="merchantId" />
		<result column="exception_type" property="exceptionType" />
		 <result column="exception_msg" property="exceptionMsg" /> 
		<result column="exception_code" property="exceptionCode" />
		<result column="retry_count" property="retryCount" />
		<result column="created_on" property="createdDate" />
		<result column="updated_on" property="updatedDate" />
		<result column="tsm_time_stamp" property="tsmTimeStamp" />
	</resultMap>
	
	<resultMap id="resultPaymentsViewAudit"
		type="com.snapdeal.payments.view.entity.PaymentsViewAuditEntity">
		<result column="freecharge_txn_id" property="fcTxnId" />
		<result column="txn_type" property="txnType" />
		<result column="exception_type" property="exceptionType" />
		 <result column="exception_msg" property="exceptionMsg" /> 
		<result column="exception_code" property="exceptionCode" />
		<result column="retry_count" property="retryCount" />
		<result column="created_on" property="createdDate" />
		<result column="updated_on" property="updatedDate" />
		<result column="tsm_time_stamp" property="tsmTimeStamp" />
	</resultMap>

	<sql id="base_column_list_payment_view_aaudit">
		freecharge_txn_id,txn_type,exception_type,exception_msg,
		exception_code,tsm_time_stamp
	</sql>
	<sql id="base_column_list_merchant_view_aaudit">
		freecharge_txn_id,txn_type,merchant_id,exception_type,exception_msg,
		exception_code,tsm_time_stamp
	</sql>	
	<insert id="saveMerchantViewAuditEntity"
		parameterType="com.snapdeal.payments.view.entity.MerchantViewAuditEntity">
		INSERT INTO merchant_view_audit(
		<include refid="base_column_list_merchant_view_aaudit" />
		)
		VALUES(
			#{fcTxnId},#{txnType},#{merchantId},#{exceptionType},#{exceptionMsg},
			#{exceptionCode},#{tsmTimeStamp}
		)
	</insert>
	<update id="updateMerchantViewAuditEntity" parameterType="com.snapdeal.payments.view.entity.MerchantViewAuditEntity">
		<![CDATA[
		UPDATE merchant_view_audit
		SET exception_type = #{exceptionType},
			exception_msg = #{exceptionMsg},
			exception_code = #{exceptionCode},
			retry_count = retry_count+1,
			tsm_time_stamp = #{tsmTimeStamp},
			status=#{status}
		WHERE freecharge_txn_id = #{fcTxnId} AND 
				txn_type = #{txnType} 
		]]>
	</update>	
	<update id="updateMerchantViewAuditStatus" parameterType="java.util.Map">
		UPDATE merchant_view_audit
		set status = #{status} 
		where freecharge_txn_id = #{fcTxnId} AND
				txn_type = #{txnType} 
	</update>
	
	<select id="getMerchantViewAuditEntity" parameterType="java.util.Map"
		resultMap="resultMerchantViewAudit">
		SELECT <include refid="base_column_list_merchant_view_aaudit" />
				,retry_count,created_on,updated_on
		FROM merchant_view_audit
		where freecharge_txn_id = #{fcTxnId} AND
				txn_type = #{txnType};
	</select>	
	<select id="getMerchantViewAuditDetailsInChunks" 
			parameterType="com.snapdeal.payments.view.merchant.commons.request.RetryPaymentsViewAuditRequest" 
			resultMap="resultPaymentsViewAudit">
			SELECT <include refid="base_column_list_payment_view_aaudit" />
				,retry_count,created_on,updated_on
			FROM merchant_view_audit 
			<![CDATA[
			WHERE retry_count < #{retryCount} 
			]]> 
			AND status = #{status}
			<if test="txnTypeList!=null and !txnTypeList.isEmpty()">
				AND txn_type IN
				<foreach item="item" index = "index" collection="txnTypeList" 
					open="(" separator="," close=")">
					#{item}
				</foreach>
			</if>
			<if test="errorCode!=null and !errorCode.isEmpty()">
				AND exception_code IN
				<foreach item="item" index = "index" collection="errorCode" 
					open="(" separator="," close=")">
					#{item}
				</foreach>
			</if>
			<if test="exceptionType!=null and !exceptionType.isEmpty()">
				AND exception_type IN
				<foreach item="item" index = "index" collection="exceptionType" 
					open="(" separator="," close=")">
					#{item}
				</foreach>
			</if>
			<if test="txnType!=null and !txnType.isEmpty()">
				AND txn_type IN
				<foreach item="item" index = "index" collection="txnType" 
					open="(" separator="," close=")">
					#{item}
				</foreach>
			</if>
			ORDER BY freecharge_txn_id
			LIMIT #{limit}
	</select>
</mapper>